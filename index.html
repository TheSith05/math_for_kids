<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-200">
  <div class="min-h-screen p-2 sm:p-4 flex flex-col items-center bg-gradient-to-b from-blue-200 to-green-200">
    <div id="level-buttons" class="flex gap-2 mb-4">
      <button class="w-10 h-10 rounded-full text-white font-bold bg-blue-600 hover:bg-blue-500 transition-transform transform hover:scale-105" data-level="1">1</button>
      <button class="w-10 h-10 rounded-full text-white font-bold bg-blue-400 hover:bg-blue-500 transition-transform transform hover:scale-105" data-level="2">2</button>
      <button class="w-10 h-10 rounded-full text-white font-bold bg-blue-400 hover:bg-blue-500 transition-transform transform hover:scale-105" data-level="3">3</button>
      <button class="w-10 h-10 rounded-full text-white font-bold bg-blue-400 hover:bg-blue-500 transition-transform transform hover:scale-105" data-level="4">4</button>
      <button class="w-10 h-10 rounded-full text-white font-bold bg-blue-400 hover:bg-blue-500 transition-transform transform hover:scale-105" data-level="5">5</button>
    </div>
    <div id="faq-button" class="absolute top-4 left-4 text-2xl cursor-pointer">‚ùì</div>
    <div id="shop-button" class="absolute top-4 left-12 text-2xl cursor-pointer">üõí</div>
    <div id="faq-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">–û –∏–≥—Ä–µ</h2>
          <span id="faq-close" class="text-xl cursor-pointer">‚úñ</span>
        </div>
        <p class="mb-2"><strong>–£—Ä–æ–≤–µ–Ω—å 1:</strong> –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã (1‚Äì10), —Å–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ, –±–µ–∑ —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–π.</p>
        <p class="mb-2"><strong>–£—Ä–æ–≤–µ–Ω—å 2:</strong> –ß–∏—Å–ª–∞ 1‚Äì20, —Å–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ, —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —á–∏—Å–ª–∞.</p>
        <p class="mb-2"><strong>–£—Ä–æ–≤–µ–Ω—å 3:</strong> –¢—Ä–∏ —á–∏—Å–ª–∞ (1‚Äì20, 1‚Äì10), –¥–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —á–∏—Å–ª–∞.</p>
        <p class="mb-2"><strong>–£—Ä–æ–≤–µ–Ω—å 4:</strong> –ß–∏—Å–ª–∞ 1‚Äì20, —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ 10.</p>
        <p class="mb-2"><strong>–£—Ä–æ–≤–µ–Ω—å 5:</strong> –¢—Ä–∏ —á–∏—Å–ª–∞, —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —á–∏—Å–ª–∞, —Å–ª–æ–∂–µ–Ω–∏–µ/–≤—ã—á–∏—Ç–∞–Ω–∏–µ.</p>
        <p class="mb-2"><strong>–ú–∞–≥–∞–∑–∏–Ω:</strong> –ü–æ–∫—É–ø–∞–π –±–æ–Ω—É—Å—ã –∑–∞ ‚≠ê: +10 HP, –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∫–æ—Ç–∞, –≠–º–æ—Ü–∏–∏ –≥–µ—Ä–æ—è, –ù–æ–≤—ã–µ –≥–µ—Ä–æ–∏!</p>
        <p class="mb-2"><strong>–ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong> –ü–æ—Å–ª–µ 2 –æ—à–∏–±–æ–∫ –∫–æ—Ç–∏–∫ –ø–æ–∫–∞–∂–µ—Ç –æ—Ç–≤–µ—Ç, –Ω–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç 1 ‚≠ê –∏ 5 HP.</p>
        <p class="mb-2"><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong></p>
        <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="correct-stats">0</span></p>
        <p>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="incorrect-stats">0</span></p>
        <p>–ú–∞–∫—Å–∏–º—É–º –∑–≤—ë–∑–¥: <span id="max-stars-stats">0</span></p>
        <p class="mt-4"><strong>–ù–æ–≤–∞—è –∏–≥—Ä–∞:</strong> –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ <code>250989</code> –∏ –Ω–∞–∂–º–∏—Ç–µ "–í–≤–æ–¥" –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.</p>
      </div>
    </div>
    <div id="shop-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">–ú–∞–≥–∞–∑–∏–Ω ‚≠ê</h2>
          <span id="shop-close" class="text-xl cursor-pointer">‚úñ</span>
        </div>
        <div id="shop-items" class="grid grid-cols-2 gap-4">
          <!-- –†–µ–≥—É–ª–∏—Ä—É–π—Ç–µ —Ü–µ–Ω—ã –∑–¥–µ—Å—å: data-item –∏ —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20 ‚≠ê) -->
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hp">
            <span class="text-2xl">‚ù§Ô∏è</span><br>+10 HP<br>20 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hint">
            <span class="text-2xl">üí°</span><br>–ü–æ–¥—Å–∫–∞–∑–∫–∞<br>15 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="emotion">
            <span class="text-2xl">üåü</span><br>–≠–º–æ—Ü–∏–∏ –≥–µ—Ä–æ—è<br>40 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="emotion2">
            <span class="text-2xl">‚ú®</span><br>–≠–º–æ—Ü–∏–∏ –≥–µ—Ä–æ—è 2<br>50 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hero-lion">
            <span class="text-2xl">ü¶Å</span><br>–ì–µ—Ä–æ–π: –õ–µ–≤<br>30 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hero-panda">
            <span class="text-2xl">üêº</span><br>–ì–µ—Ä–æ–π: –ü–∞–Ω–¥–∞<br>30 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hero-unicorn">
            <span class="text-2xl">ü¶Ñ</span><br>–ì–µ—Ä–æ–π: –ï–¥–∏–Ω–æ—Ä–æ–≥<br>30 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hero-princess">
            <span class="text-2xl">üë∏</span><br>–ì–µ—Ä–æ–π: –ü—Ä–∏–Ω—Ü–µ—Å—Å–∞<br>30 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hero-scorpion">
            <span class="text-2xl">ü¶Ç</span><br>–ì–µ—Ä–æ–π: –°–∫–æ—Ä–ø–∏–æ–Ω<br>30 ‚≠ê
          </button>
          <button class="bg-yellow-400 hover:bg-yellow-500 p-4 rounded-lg text-center" data-item="hero-merlin">
            <span class="text-2xl">üßô</span><br>–ì–µ—Ä–æ–π: –ú–µ—Ä–ª–∏–Ω<br>30 ‚≠ê
          </button>
        </div>
      </div>
    </div>
    <div id="avatar-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg max-w-md w-full">
        <h2 class="text-2xl font-bold mb-4">–í—ã–±–µ—Ä–∏ –∞–≤–∞—Ç–∞—Ä–∫—É</h2>
        <div id="avatar-options" class="grid grid-cols-3 gap-4"></div>
      </div>
    </div>
    <div id="star-count" class="absolute top-4 right-4 flex flex-col items-center">
      <span class="text-2xl">‚≠ê</span>
      <span id="star-number" class="text-xl font-bold">0</span>
    </div>
    <div class="flex items-center justify-center mb-4 relative">
      <div id="hint" class="hidden text-xl font-bold text-blue-600 absolute" style="left: calc(50% - 200px); text-align: left; max-width: 120px;"></div>
      <div id="cat" class="text-6xl mr-4">üò∫</div>
      <div id="emotion" class="absolute text-3xl hidden"></div>
      <div id="crit-counter" class="text-xl font-bold">‚ö° 0/7</div>
    </div>
    <div id="example" class="text-4xl font-bold mb-4" style="font-size: 36px;"></div>
    <div class="flex items-center justify-center w-full mt-8 mb-4">
      <div class="flex flex-col items-center mr-4">
        <div id="enemy" class="text-4xl mb-2">ü¶ù</div>
        <div id="enemy-hp" class="w-20 h-4 bg-gray-300 rounded-full overflow-hidden relative">
          <div id="enemy-hp-bar" class="h-full bg-red-500" style="width: 100%;"></div>
          <span id="enemy-hp-text" class="absolute inset-0 text-white text-sm font-bold flex items-center justify-center">80/80</span>
        </div>
      </div>
      <div id="answer" class="text-2xl mx-4 w-32 text-center">–û—Ç–≤–µ—Ç: </div>
      <div class="flex flex-col items-center ml-4">
        <div id="player" class="text-4xl mb-2">üê∂</div>
        <div id="player-hp" class="w-20 h-4 bg-gray-300 rounded-full overflow-hidden relative">
          <div id="player-hp-bar" class="h-full bg-green-500" style="width: 100%;"></div>
          <span id="player-hp-text" class="absolute inset-0 text-white text-sm font-bold flex items-center justify-center">100/100</span>
        </div>
      </div>
    </div>
    <div class="grid grid-cols-3 gap-2 w-80" id="input-buttons">
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">1</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">2</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">3</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">4</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">5</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">6</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">7</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">8</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">9</button>
      <button class="bg-yellow-400 hover:bg-yellow-500 text-3xl font-bold p-4 rounded-lg transition-transform transform hover:scale-105">0</button>
      <button id="submit" class="bg-green-500 hover:bg-green-600 text-white text-2xl font-bold p-6 rounded-lg transition-transform transform hover:scale-105 flex justify-center items-center">–í–≤–æ–¥</button>
      <button id="clear" class="bg-red-500 hover:bg-red-600 text-white text-xl font-bold p-6 rounded-lg transition-transform transform hover:scale-105 flex justify-center items-center">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </div>

  <script>
    let level = 1;
    let example = {};
    let examplesByLevel = JSON.parse(localStorage.getItem('examplesByLevel')) || {};
    let answer = '';
    let codeInput = '';
    let stars = parseInt(localStorage.getItem('stars')) || 0;
    let correctCount = 0;
    let streak = 0;
    let playerHP = parseInt(localStorage.getItem('playerHP')) || 100;
    let enemyHP = parseInt(localStorage.getItem('enemyHP')) || 80;
    let enemyHPMultiplier = parseFloat(localStorage.getItem('enemyHPMultiplier')) || 1.0;
    let currentEnemyIndex = parseInt(localStorage.getItem('currentEnemyIndex')) || 0;
    let playerAvatar = localStorage.getItem('playerAvatar') || 'üê∂';
    let catAvatar = localStorage.getItem('catAvatar') || 'üò∫';
    let correctAnswers = parseInt(localStorage.getItem('correctAnswers')) || 0;
    let incorrectAnswers = parseInt(localStorage.getItem('incorrectAnswers')) || 0;
    let maxStars = parseInt(localStorage.getItem('maxStars')) || 0;
    let incorrectAttempts = 0;
    let emotionMode = localStorage.getItem('emotionMode') === 'true';
    let emotionSet = parseInt(localStorage.getItem('emotionSet')) || 0; // 0: –±–µ–∑ —ç–º–æ—Ü–∏–π, 1: –ø–µ—Ä–≤—ã–π –Ω–∞–±–æ—Ä, 2: –≤—Ç–æ—Ä–æ–π
    const playerAvatars = ['ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶∏', 'üê∞', 'ü¶ù', 'üêá', 'üï∑Ô∏è', 'üë∏', 'ü¶ñ'];
    // –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã—Ö –≥–µ—Ä–æ–µ–≤ –≤ catHeroes
    const catHeroes = ['üò∫', 'ü¶Å', 'üêº', 'ü¶Ñ', 'üë∏', 'ü¶Ç', 'üßô'];
    const enemies = [
      { emoji: 'ü¶ù', baseHP: 80 },
      { emoji: 'üê∫', baseHP: 100 },
      { emoji: 'üêª', baseHP: 120 },
      { emoji: 'ü¶ä', baseHP: 90 },
      { emoji: 'üêç', baseHP: 150 }
    ];

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function generateExample() {
      let num1, num2, num3, op1, op2, result, decomposition;
      if (level === 1) {
        num1 = Math.floor(Math.random() * 10) + 1;
        op1 = Math.random() > 0.5 ? '+' : '-';
        num2 = Math.floor(Math.random() * (op1 === '-' ? num1 : 10 - num1 + 1)) + 1;
        result = op1 === '+' ? num1 + num2 : num1 - num2;
        if (op1 === '+' && result > 10) return generateExample();
      } else if (level === 2) {
        num1 = Math.floor(Math.random() * 20) + 1;
        op1 = Math.random() > 0.5 ? '+' : '-';
        num2 = Math.floor(Math.random() * (op1 === '-' ? num1 : 10)) + 1;
        result = op1 === '+' ? num1 + num2 : num1 - num2;
        if (result > 20) return generateExample();
        decomposition = decomposeNumber(num2, op1, num1);
      } else if (level === 3) {
        num1 = Math.floor(Math.random() * 20) + 1;
        op1 = Math.random() > 0.5 ? '+' : '-';
        num2 = Math.floor(Math.random() * (op1 === '-' ? num1 : 10)) + 1;
        const tempResult = op1 === '+' ? num1 + num2 : num1 - num2;
        if (tempResult < 0 || tempResult > 20) return generateExample();
        num3 = Math.floor(Math.random() * 10) + 1;
        op2 = Math.random() > 0.5 ? '+' : '-';
        if (op2 === '+' && tempResult + num3 > 10) return generateExample();
        if (op2 === '-' && tempResult - num3 < 0) return generateExample();
        result = op2 === '+' ? tempResult + num3 : tempResult - num3;
        if (result > 20) return generateExample();
        decomposition = decomposeNumber(num2, op1, num1);
      } else if (level === 4) {
        op1 = Math.random() > 0.5 ? '+' : '-';
        if (op1 === '-') {
          num1 = Math.floor(Math.random() * 10) + 11;
          const part1 = num1 - 10;
          const part2 = Math.floor(Math.random() * (10 - part1)) + 1;
          num2 = part1 + part2;
          result = num1 - num2;
        } else {
          num1 = Math.floor(Math.random() * 9) + 1;
          const part1 = 10 - num1;
          const part2 = Math.floor(Math.random() * (10 - part1)) + 1;
          num2 = part1 + part2;
          result = num1 + num2;
        }
        if (result > 20) return generateExample();
        decomposition = decomposeNumber(num2, op1, num1);
        if (!decomposition) return generateExample();
      } else if (level === 5) {
        op1 = Math.random() > 0.5 ? '+' : '-';
        if (op1 === '-') {
          num1 = Math.floor(Math.random() * 10) + 11;
          const part1 = num1 - 10;
          const part2 = Math.floor(Math.random() * (10 - part1)) + 1;
          num2 = part1 + part2;
          const tempResult = num1 - num2;
          if (tempResult > 20) return generateExample();
          num3 = Math.floor(Math.random() * 10) + 1;
          op2 = Math.random() > 0.5 ? '+' : '-';
          if (op2 === '+' && tempResult + num3 > 10) return generateExample();
          if (op2 === '-' && tempResult - num3 < 0) return generateExample();
          result = op2 === '+' ? tempResult + num3 : tempResult - num3;
        } else {
          num1 = Math.floor(Math.random() * 9) + 1;
          const part1 = 10 - num1;
          const part2 = Math.floor(Math.random() * (10 - part1)) + 1;
          num2 = part1 + part2;
          const tempResult = num1 + num2;
          if (tempResult > 20) return generateExample();
          num3 = Math.floor(Math.random() * 10) + 1;
          op2 = Math.random() > 0.5 ? '+' : '-';
          if (op2 === '+' && tempResult + num3 > 10) return generateExample();
          if (op2 === '-' && tempResult - num3 < 0) return generateExample();
          result = op2 === '+' ? tempResult + num3 : tempResult - num3;
        }
        if (result > 20) return generateExample();
        decomposition = decomposeNumber(num2, op1, num1);
        if (!decomposition) return generateExample();
      }
      if (result < 0) return generateExample();
      return { num1, num2, num3, op1, op2, result, decomposition };
    }

    function decomposeNumber(num, op1, num1) {
      if (num <= 1) return null;
      if (op1 === '-') {
        const part1 = num1 - 10;
        if (part1 <= 0 || part1 >= num) return null;
        const part2 = num - part1;
        if (part2 <= 0) return null;
        return [part1, part2];
      } else if (op1 === '+') {
        const part1 = 10 - num1;
        if (part1 <= 0 || part1 >= num || num1 + num < 10) return null;
        const part2 = num - part1;
        if (part2 <= 0) return null;
        return [part1, part2];
      }
      return null;
    }

    function showDamage(targetId, damage, color) {
      const target = document.getElementById(targetId);
      const damageText = document.createElement('span');
      damageText.textContent = `-üí•${damage}`;
      damageText.className = `absolute text-${color}-500 text-xl font-bold`;
      target.parentNode.appendChild(damageText);
      const targetRect = target.getBoundingClientRect();
      damageText.style.left = `${targetRect.left + targetRect.width / 2 - damageText.offsetWidth / 2}px`;
      damageText.style.top = `${targetRect.top}px`;
      gsap.to(damageText, {
        y: -50,
        scale: 1.7,
        opacity: 0,
        duration: 0.7,
        ease: 'power2.out',
        onComplete: () => damageText.remove()
      });
    }

    function showBonus(targetId, value, color) {
      const target = document.getElementById(targetId);
      const bonusText = document.createElement('span');
      bonusText.textContent = `+${value}`;
      bonusText.className = `absolute text-${color}-500 text-xl font-bold`;
      target.parentNode.appendChild(bonusText);
      const targetRect = target.getBoundingClientRect();
      bonusText.style.left = `${targetRect.left + targetRect.width / 2 - bonusText.offsetWidth / 2}px`;
      bonusText.style.top = `${targetRect.top}px`;
      gsap.to(bonusText, {
        y: -50,
        scale: 1.7,
        opacity: 0,
        duration: 0.7,
        ease: 'power2.out',
        onComplete: () => bonusText.remove()
      });
    }

    function showEmotion(emoji, isCorrect, isCrit) {
      if (emotionSet === 0) return;
      const emotionDiv = document.getElementById('emotion');
      // –í—ã–±–æ—Ä —Å–º–∞–π–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–±–æ—Ä–∞
      const emotions = emotionSet === 1 ?
        { incorrect: 'üíß', correct: 'üåü', crit: '‚ù§Ô∏è' } :
        { incorrect: 'üí¶', correct: '‚ú®', crit: 'üíñ' };
      emotionDiv.textContent = emoji === 'incorrect' ? emotions.incorrect :
                              emoji === 'correct' ? emotions.correct : emotions.crit;
      emotionDiv.classList.remove('hidden');

      const cat = document.getElementById('cat');
      const catRect = cat.getBoundingClientRect();
      const container = cat.parentNode;
      const containerRect = container.getBoundingClientRect();

      const left = catRect.left - containerRect.left + (catRect.width / 2) - (emotionDiv.offsetWidth / 2) + 35;
      const top = catRect.top - containerRect.top - emotionDiv.offsetHeight + 25;

      emotionDiv.style.left = `${left}px`;
      emotionDiv.style.top = `${top}px`;

      // –≠—Ñ—Ñ–µ–∫—Ç–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏: –≤—Ä–∞—â–µ–Ω–∏–µ, —Ç–µ–Ω—å, –∫—Ä–∏–≤–∞—è
      gsap.fromTo('#emotion', 
        { y: 0, scale: 1, opacity: 1, rotation: 0 }, 
        {
          y: -50,
          x: isCorrect ? 20 : -20, // –°–º–µ—â–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ/–≤–ª–µ–≤–æ
          scale: emoji === 'crit' ? 2 : 1.5,
          rotation: isCrit ? 360 : 180, // –í—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è –∫—Ä–∏—Ç–∞
          opacity: 0,
          duration: 1.2,
          ease: 'power3.out',
          filter: 'drop-shadow(0 0 10px rgba(255, 255, 0, 0.8))', // –¢–µ–Ω—å
          onComplete: () => {
            emotionDiv.classList.add('hidden');
            gsap.set('#emotion', { filter: 'none' });
          }
        }
      );

      // –ê–Ω–∏–º–∞—Ü–∏–∏ –∫–æ—Ç–∞
      if (isCorrect) {
        gsap.to('#cat', {
          scale: 1.2,
          duration: 0.5,
          yoyo: true,
          repeat: 1,
          onComplete: () => gsap.set('#cat', { scale: 1 })
        });
      } else if (isCrit) {
        gsap.to('#cat', {
          scale: 1.5,
          rotation: 360,
          duration: 1,
          ease: 'elastic',
          onComplete: () => gsap.set('#cat', { scale: 1, rotation: 0 })
        });
      } else {
        gsap.to('#cat', {
          x: -15,
          rotation: 5,
          duration: 0.2,
          yoyo: true,
          repeat: 3,
          onComplete: () => gsap.set('#cat', { x: 0, rotation: 0 })
        });
      }
    }

    function showHint() {
      const hintDiv = document.getElementById('hint');
      hintDiv.innerHTML = `üí° –û—Ç–≤–µ—Ç:<br><div class="text-center">${example.result}</div>`;
      hintDiv.classList.remove('hidden');
      gsap.fromTo('#hint', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 0.5, ease: 'bounce' });
      setTimeout(() => {
        gsap.to('#hint', { opacity: 0, y: 20, duration: 0.5, onComplete: () => {
          hintDiv.classList.add('hidden');
        }});
      }, 5000);
      stars = Math.max(0, stars - 1);
      playerHP = Math.max(0, playerHP - 5);
      localStorage.setItem('stars', stars);
      localStorage.setItem('playerHP', playerHP);
      document.getElementById('star-number').textContent = stars;
      document.getElementById('player-hp-bar').style.width = `${playerHP}%`;
      document.getElementById('player-hp-text').textContent = `${playerHP}/100`;
      if (playerHP <= 0) resetGame();
    }

    function updateHPText() {
      document.getElementById('enemy-hp-text').textContent = `${enemyHP}/${Math.round(enemies[currentEnemyIndex].baseHP * enemyHPMultiplier)}`;
      document.getElementById('player-hp-text').textContent = `${playerHP}/100`;
    }

    function resetGame() {
      localStorage.setItem('maxStars', maxStars);
      stars = 0;
      correctCount = 0;
      streak = 0;
      playerHP = 100;
      enemyHP = enemies[0].baseHP;
      currentEnemyIndex = 0;
      enemyHPMultiplier = 1.0;
      correctAnswers = 0;
      incorrectAnswers = 0;
      incorrectAttempts = 0;
      emotionMode = false;
      emotionSet = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞–±–æ—Ä —ç–º–æ—Ü–∏–π
      catAvatar = 'üò∫';
      examplesByLevel = {};
      localStorage.setItem('stars', stars);
      localStorage.setItem('playerHP', playerHP);
      localStorage.setItem('enemyHP', enemyHP);
      localStorage.setItem('currentEnemyIndex', currentEnemyIndex);
      localStorage.setItem('enemyHPMultiplier', enemyHPMultiplier);
      localStorage.setItem('correctAnswers', correctAnswers);
      localStorage.setItem('incorrectAnswers', incorrectAnswers);
      localStorage.setItem('emotionMode', emotionMode);
      localStorage.setItem('emotionSet', emotionSet);
      localStorage.setItem('catAvatar', catAvatar);
      localStorage.setItem('examplesByLevel', JSON.stringify(examplesByLevel));
      document.getElementById('enemy').textContent = enemies[currentEnemyIndex].emoji;
      document.getElementById('cat').textContent = catAvatar;
      document.getElementById('star-number').textContent = '0';
      document.getElementById('crit-counter').textContent = '‚ö° 0/7';
      document.getElementById('player-hp-bar').style.width = '100%';
      document.getElementById('enemy-hp-bar').style.width = '100%';
      document.getElementById('cat').textContent = catAvatar;
      document.getElementById('correct-stats').textContent = correctAnswers;
      document.getElementById('incorrect-stats').textContent = incorrectAnswers;
      document.getElementById('max-stars-stats').textContent = maxStars;
      updateHPText();
      gsap.to('#cat', {
        scale: 1.5,
        rotation: 360,
        duration: 1,
        ease: 'elastic',
        onComplete: () => gsap.set('#cat', { scale: 1, rotation: 0 })
      });
      codeInput = '';
      answer = '';
      document.getElementById('answer').textContent = '–û—Ç–≤–µ—Ç: ';
      const avatarModal = document.getElementById('avatar-modal');
      const avatarOptions = document.getElementById('avatar-options');
      avatarOptions.innerHTML = '';
      playerAvatars.forEach(avatar => {
        const btn = document.createElement('button');
        btn.textContent = avatar;
        btn.className = 'text-4xl p-2 rounded-lg hover:bg-gray-200';
        btn.addEventListener('click', () => {
          playerAvatar = avatar;
          localStorage.setItem('playerAvatar', avatar);
          document.getElementById('player').textContent = avatar;
          avatarModal.classList.add('hidden');
          updateExample();
        });
        avatarOptions.appendChild(btn);
      });
      avatarModal.classList.remove('hidden');
    }

    function updateExample() {
      if (examplesByLevel[level]) {
        example = examplesByLevel[level];
      } else {
        example = generateExample();
        examplesByLevel[level] = example;
        localStorage.setItem('examplesByLevel', JSON.stringify(examplesByLevel));
      }
      incorrectAttempts = 0;
      const exampleDiv = document.getElementById('example');
      exampleDiv.innerHTML = `
        ${example.num1} ${example.op1} <span id="num2" class="inline-block ${example.decomposition ? 'text-gray-400' : 'text-black'}">${example.num2}</span>
        ${level === 3 || level === 5 ? ` ${example.op2} ${example.num3}` : ''} = ?
      `;
      if (level >= 2 && example.decomposition) {
        exampleDiv.innerHTML += `
          <div class="flex justify-center mt-2">
            <div class="flex flex-col items-center">
              <svg id="brace" width="100" height="50" viewBox="0 0 100 50" class="mt-0" style="position: absolute; transform: scale(1.2);">
                <defs>
                  <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color: #ff6b6b; stop-opacity: 1" />
                    <stop offset="100%" style="stop-color: #ffcc00; stop-opacity: 1" />
                  </linearGradient>
                </defs>
                <polyline points="30,40 50,17 70,40" fill="none" stroke="url(#grad)" stroke-width="4" filter="drop-shadow(2px 2px 2px rgba(0,0,0,0.3))" />
              </svg>
              <span id="decomp1" class="text-xl font-bold decomp" style="position: absolute;">${example.decomposition[0]}</span>
              <span id="decomp2" class="text-xl font-bold decomp" style="position: absolute;">${example.decomposition[1]}</span>
            </div>
          </div>
        `;
      }
      positionBrace();
      if (level >= 2 && example.decomposition) {
        requestAnimationFrame(() => {
          gsap.fromTo('#brace', { scaleY: 0, opacity: 0 }, { scaleY: 1.2, opacity: 1, duration: 0.5, ease: 'bounce' });
          gsap.fromTo('.decomp', { opacity: 0, scale: 0.9 }, { opacity: 1, scale: 1, duration: 0.5, delay: 0.1 });
        });
      }
    }

    function positionBrace() {
      if (level === 1 || !example.decomposition) return;
      requestAnimationFrame(() => {
        const num2 = document.getElementById('num2');
        const exampleDiv = document.getElementById('example');
        const brace = document.getElementById('brace');
        const decomp1 = document.getElementById('decomp1');
        const decomp2 = document.getElementById('decomp2');
        const num2Rect = num2.getBoundingClientRect();
        const exampleRect = exampleDiv.getBoundingClientRect();
        const svgWidth = 120;
        const exampleLeft = (window.innerWidth - exampleRect.width) / 2;
        const num2CenterX = num2Rect.left + num2Rect.width;
        const adjustment = num2.textContent.length > 1 && window.innerWidth < 640 ? -7 : num2.textContent.length > 1 ? -5 : 0;
        const svgLeft = num2CenterX + adjustment - svgWidth / 2;
        brace.style.left = `${svgLeft}px`;
        const num2Top = num2Rect.top + window.scrollY;
        const desiredTop = num2Top + 50;
        brace.style.top = `${desiredTop - 20.4}px`;
        const braceRect = brace.getBoundingClientRect();
        decomp1.style.left = `${braceRect.left + 30}px`;
        decomp2.style.left = `${braceRect.left + 78}px`;
        decomp1.style.top = `${braceRect.top + window.scrollY + 48}px`;
        decomp2.style.top = `${braceRect.top + window.scrollY + 48}px`;
      });
    }

    const debouncedPositionBrace = debounce(positionBrace, 16);

    document.getElementById('faq-button').addEventListener('click', () => {
      document.getElementById('faq-modal').classList.toggle('hidden');
    });
    document.getElementById('faq-close').addEventListener('click', () => {
      document.getElementById('faq-modal').classList.add('hidden');
    });

    document.getElementById('shop-button').addEventListener('click', () => {
      document.getElementById('shop-modal').classList.toggle('hidden');
    });
    document.getElementById('shop-close').addEventListener('click', () => {
      document.getElementById('shop-modal').classList.add('hidden');
    });

    document.getElementById('shop-items').addEventListener('click', (event) => {
      if (event.target.tagName !== 'BUTTON') return;
      const item = event.target.dataset.item;
      // –†–µ–≥—É–ª–∏—Ä—É–π—Ç–µ —Ü–µ–Ω—ã –∑–¥–µ—Å—å: –∑–∞–¥–∞–≤–∞–π—Ç–µ cost –¥–ª—è –∫–∞–∂–¥–æ–≥–æ item
      let cost = 0;
      if (item === 'hp') cost = 20;
      else if (item === 'hint') cost = 15;
      else if (item === 'emotion') cost = 40;
      else if (item === 'emotion2') cost = 50;
      else if (item.startsWith('hero-')) cost = 30;
      if (stars < cost) {
        gsap.to('#shop-modal', { x: 10, duration: 0.1, yoyo: true, repeat: 5 });
        return;
      }
      stars -= cost;
      localStorage.setItem('stars', stars);
      document.getElementById('star-number').textContent = stars;
      if (item === 'hp') {
        playerHP = Math.min(100, playerHP + 10);
        localStorage.setItem('playerHP', playerHP);
        document.getElementById('player-hp-bar').style.width = `${playerHP}%`;
        document.getElementById('player-hp-text').textContent = `${playerHP}/100`;
        showBonus('player', 10, 'green');
      } else if (item === 'hint') {
        showHint();
      } else if (item === 'emotion') {
        emotionMode = true;
        emotionSet = 1; // –ü–µ—Ä–≤—ã–π –Ω–∞–±–æ—Ä —ç–º–æ—Ü–∏–π
        localStorage.setItem('emotionMode', emotionMode);
        localStorage.setItem('emotionSet', emotionSet);
      } else if (item === 'emotion2') {
        emotionMode = true;
        emotionSet = 2; // –í—Ç–æ—Ä–æ–π –Ω–∞–±–æ—Ä —ç–º–æ—Ü–∏–π
        localStorage.setItem('emotionMode', emotionMode);
        localStorage.setItem('emotionSet', emotionSet);
      } else if (item === 'hero-lion') {
        catAvatar = 'ü¶Å';
        localStorage.setItem('catAvatar', catAvatar);
        document.getElementById('cat').textContent = catAvatar;
      } else if (item === 'hero-panda') {
        catAvatar = 'üêº';
        localStorage.setItem('catAvatar', catAvatar);
        document.getElementById('cat').textContent = catAvatar;
      } else if (item === 'hero-unicorn') {
        catAvatar = 'ü¶Ñ';
        localStorage.setItem('catAvatar', catAvatar);
        document.getElementById('cat').textContent = catAvatar;
      } else if (item === 'hero-princess') {
        catAvatar = 'üë∏';
        localStorage.setItem('catAvatar', catAvatar);
        document.getElementById('cat').textContent = catAvatar;
      } else if (item === 'hero-scorpion') {
        catAvatar = 'ü¶Ç';
        localStorage.setItem('catAvatar', catAvatar);
        document.getElementById('cat').textContent = catAvatar;
      } else if (item === 'hero-merlin') {
        catAvatar = 'üßô';
        localStorage.setItem('catAvatar', catAvatar);
        document.getElementById('cat').textContent = catAvatar;
      }
      gsap.to(event.target, { scale: 1.2, duration: 0.3, yoyo: true, repeat: 1 });
      document.getElementById('shop-modal').classList.add('hidden');
    });

    document.getElementById('input-buttons').addEventListener('click', (event) => {
      if (event.target.tagName !== 'BUTTON') return;
      const value = event.target.textContent;
      if (value === '–í–≤–æ–¥') {
        if (answer === '') return;
        if (codeInput === '250989') {
          resetGame();
        } else if (!isNaN(parseInt(answer)) && parseInt(answer) === example.result) {
          streak++;
          correctCount++;
          correctAnswers++;
          incorrectAttempts = 0;
          localStorage.setItem('correctAnswers', correctAnswers);
          document.getElementById('correct-stats').textContent = correctAnswers;
          const damage = correctCount >= 7 ? 2 * (10 + 5 * level) : 10 + 5 * level;
          const color = correctCount >= 7 ? 'orange' : 'red';
          let starReward = level <= 2 ? 1 : level <= 4 ? 2 : 3;
          if (correctCount >= 7) {
            starReward += 5;
            if (emotionMode) {
              showEmotion('crit', false, true);
            } else {
              gsap.to('#cat', {
                scale: 1.5,
                rotation: 360,
                duration: 1,
                ease: 'elastic',
                onComplete: () => gsap.set('#cat', { scale: 1, rotation: 0 })
              });
            }
            correctCount = 0;
          } else if (emotionMode) {
            showEmotion('correct', true, false);
          }
          document.getElementById('crit-counter').textContent = `‚ö° ${correctCount}/7`;
          enemyHP = Math.max(0, enemyHP - damage);
          localStorage.setItem('enemyHP', enemyHP);
          document.getElementById('enemy-hp-bar').style.width = `${(enemyHP / (enemies[currentEnemyIndex].baseHP * enemyHPMultiplier)) * 100}%`;
          document.getElementById('enemy-hp-text').textContent = `${enemyHP}/${Math.round(enemies[currentEnemyIndex].baseHP * enemyHPMultiplier)}`;
          gsap.to('#enemy', {
            x: '+=5',
            y: -5,
            scale: 0.95,
            rotation: 5,
            duration: 0.1,
            yoyo: true,
            repeat: 6,
            onComplete: () => gsap.set('#enemy', { x: 0, y: 0, scale: 1, rotation: 0 })
          });
          showDamage('enemy', damage, color);
          stars += starReward;
          maxStars = Math.max(maxStars, stars);
          localStorage.setItem('stars', stars);
          localStorage.setItem('maxStars', maxStars);
          document.getElementById('star-number').textContent = stars;
          document.getElementById('max-stars-stats').textContent = maxStars;
          gsap.to('#star-count', { scale: 1.2, duration: 0.3, yoyo: true, repeat: 1 });
          if (enemyHP <= 0) {
            currentEnemyIndex = (currentEnemyIndex + 1) % enemies.length;
            enemyHP = Math.round(enemies[currentEnemyIndex].baseHP * enemyHPMultiplier);
            localStorage.setItem('enemyHP', enemyHP);
            localStorage.setItem('currentEnemyIndex', currentEnemyIndex);
            document.getElementById('enemy').textContent = enemies[currentEnemyIndex].emoji;
            document.getElementById('enemy-hp-bar').style.width = '100%';
            document.getElementById('enemy-hp-text').textContent = `${enemyHP}/${Math.round(enemies[currentEnemyIndex].baseHP * enemyHPMultiplier)}`;
            gsap.to('#enemy', { opacity: 0, duration: 0.3, onComplete: () => {
              gsap.to('#enemy', { opacity: 1, duration: 0.3 });
            }});
            if (currentEnemyIndex === 0) {
              enemyHPMultiplier += 0.1;
              localStorage.setItem('enemyHPMultiplier', enemyHPMultiplier);
              playerHP = Math.min(100, playerHP + 5);
              localStorage.setItem('playerHP', playerHP);
              document.getElementById('player-hp-bar').style.width = `${playerHP}%`;
              document.getElementById('player-hp-text').textContent = `${playerHP}/100`;
              showBonus('player', 5, 'green');
              stars += 10;
              maxStars = Math.max(maxStars, stars);
              localStorage.setItem('stars', stars);
              localStorage.setItem('maxStars', maxStars);
              document.getElementById('star-number').textContent = stars;
              document.getElementById('max-stars-stats').textContent = maxStars;
            }
          }
          answer = '';
          codeInput = '';
          document.getElementById('answer').textContent = '–û—Ç–≤–µ—Ç: ';
          delete examplesByLevel[level];
          localStorage.setItem('examplesByLevel', JSON.stringify(examplesByLevel));
          updateExample();
        } else {
          incorrectAttempts++;
          streak = 0;
          correctCount = 0;
          incorrectAnswers++;
          localStorage.setItem('incorrectAnswers', incorrectAnswers);
          document.getElementById('incorrect-stats').textContent = incorrectAnswers;
          document.getElementById('crit-counter').textContent = `‚ö° ${correctCount}/7`;
          const damage = 10;
          playerHP = Math.max(0, playerHP - damage);
          localStorage.setItem('playerHP', playerHP);
          document.getElementById('player-hp-bar').style.width = `${playerHP}%`;
          document.getElementById('player-hp-text').textContent = `${playerHP}/100`;
          gsap.to('#player', {
            x: '+=5',
            y: -5,
            scale: 0.95,
            rotation: 5,
            duration: 0.1,
            yoyo: true,
            repeat: 6,
            onComplete: () => gsap.set('#player', { x: 0, y: 0, scale: 1, rotation: 0 })
          });
          showDamage('player', 10, 'purple');
          if (emotionMode) {
            showEmotion('incorrect', false, false);
          }
          stars = Math.max(0, stars - 1);
          maxStars = Math.max(maxStars, stars);
          localStorage.setItem('stars', stars);
          localStorage.setItem('maxStars', maxStars);
          document.getElementById('star-number').textContent = stars;
          document.getElementById('max-stars-stats').textContent = maxStars;
          if (incorrectAttempts >= 2) {
            showHint();
          }
          if (playerHP <= 0) {
            resetGame();
          }
          answer = '';
          codeInput = '';
          document.getElementById('answer').textContent = '–û—Ç–≤–µ—Ç: ';
        }
      } else if (value === '–û—á–∏—Å—Ç–∏—Ç—å') {
        answer = '';
        codeInput = '';
        document.getElementById('answer').textContent = '–û—Ç–≤–µ—Ç: ';
      } else {
        answer += value;
        codeInput += value;
        document.getElementById('answer').textContent = `–û—Ç–≤–µ—Ç: ${answer}`;
      }
    });

    document.getElementById('level-buttons').addEventListener('click', (event) => {
      if (event.target.tagName !== 'BUTTON') return;
      const newLevel = parseInt(event.target.dataset.level);
      if (newLevel === level) return;
      level = newLevel;
      document.querySelectorAll('#level-buttons button').forEach(btn => {
        btn.classList.remove('bg-blue-600');
        btn.classList.add('bg-blue-400');
      });
      event.target.classList.remove('bg-blue-400');
      event.target.classList.add('bg-blue-600');
      answer = '';
      codeInput = '';
      document.getElementById('answer').textContent = '–û—Ç–≤–µ—Ç: ';
      updateExample();
    });

    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem('playerAvatar')) resetGame();
      document.getElementById('star-number').textContent = stars;
      document.getElementById('enemy').textContent = enemies[currentEnemyIndex].emoji;
      document.getElementById('cat').textContent = catAvatar;
      document.getElementById('crit-counter').textContent = '‚ö° 0/7';
      document.getElementById('player').textContent = playerAvatar;
      document.getElementById('player-hp-bar').style.width = `${playerHP}%`;
      document.getElementById('enemy-hp-bar').style.width = `${(enemyHP / (enemies[currentEnemyIndex].baseHP * enemyHPMultiplier)) * 100}%`;
      document.getElementById('correct-stats').textContent = correctAnswers;
      document.getElementById('incorrect-stats').textContent = incorrectAnswers;
      document.getElementById('max-stars-stats').textContent = maxStars;
      updateHPText();
      updateExample();
    });

    window.addEventListener('resize', debouncedPositionBrace);
    window.addEventListener('scroll', debouncedPositionBrace);
  </script>
</body>
</html>
